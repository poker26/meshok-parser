#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
# –ó–∞–ø—É—Å–∫–∞—Ç—å —á–µ—Ä–µ–∑ cron –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

SERVER_URL="http://localhost:3001/api/health"
LOG_FILE="/var/log/wolmar-auto-restart.log"
MAX_RETRIES=3
RETRY_DELAY=30

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
check_server() {
    local response
    response=$(curl -s -o /dev/null -w "%{http_code}" "$SERVER_URL" 2>/dev/null)
    
    if [ "$response" = "200" ]; then
        return 0  # –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
    else
        return 1  # –°–µ—Ä–≤–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
restart_server() {
    log "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞..."
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å
    pm2 stop wolmar-parser 2>/dev/null
    
    # –ñ–¥–µ–º 5 —Å–µ–∫—É–Ω–¥
    sleep 5
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å
    pm2 start wolmar-parser 2>/dev/null
    
    # –ñ–¥–µ–º 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∑–∞–ø—É—Å–∫–∞
    sleep 10
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –ª–∏ —Å–µ—Ä–≤–µ—Ä
    if check_server; then
        log "‚úÖ –°–µ—Ä–≤–µ—Ä —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
        return 0
    else
        log "‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ —Å–±–æ—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä—Å–µ—Ä–æ–≤
analyze_crash_and_recover() {
    log "üîç –ê–Ω–∞–ª–∏–∑ —Å–±–æ—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–æ–≤..."
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑ —Å–±–æ—è
    if [ -f "analyze-crash-recovery.js" ]; then
        log "üìä –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ —Å–±–æ—è..."
        node analyze-crash-recovery.js --auto-recovery >> "$LOG_FILE" 2>&1
        
        if [ $? -eq 0 ]; then
            log "‚úÖ –ê–Ω–∞–ª–∏–∑ —Å–±–æ—è –∑–∞–≤–µ—Ä—à–µ–Ω, –ø–∞—Ä—Å–µ—Ä—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
        else
            log "‚ö†Ô∏è –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Å–±–æ—è, –Ω–æ —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
        fi
    else
        log "‚ö†Ô∏è –°–∫—Ä–∏–ø—Ç –∞–Ω–∞–ª–∏–∑–∞ —Å–±–æ—è –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–æ–≤"
    fi
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
log "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞..."

if check_server; then
    log "‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ"
    exit 0
else
    log "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫..."
    
    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–±–æ–π –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ä—Å–µ—Ä—ã
    analyze_crash_and_recover
    
    # –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
    for i in $(seq 1 $MAX_RETRIES); do
        log "üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ $i –∏–∑ $MAX_RETRIES"
        
        if restart_server; then
            log "‚úÖ –°–µ—Ä–≤–µ—Ä —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —Å –ø–æ–ø—ã—Ç–∫–∏ $i"
            exit 0
        else
            log "‚ùå –ü–æ–ø—ã—Ç–∫–∞ $i –Ω–µ—É–¥–∞—á–Ω–∞, –∂–¥–µ–º $RETRY_DELAY —Å–µ–∫—É–Ω–¥..."
            sleep $RETRY_DELAY
        fi
    done
    
    log "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –ø–æ—Å–ª–µ $MAX_RETRIES –ø–æ–ø—ã—Ç–æ–∫"
    exit 1
fi
