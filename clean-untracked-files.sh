#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# –£–¥–∞–ª—è–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–µ—à–∞—é—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—é –≤–µ—Ç–æ–∫

echo "üßπ –û—á–∏—Å—Ç–∫–∞ –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
echo "=============================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
if [ ! -f "/var/www/wolmar-parser/server.js" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ /var/www/wolmar-parser"
    exit 1
fi

cd /var/www/wolmar-parser

echo "üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å Git:"
git status

echo ""
echo "üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã:"
git status --porcelain | grep "^??"

echo ""
echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã..."

# –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –≤–∞–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
echo "üíæ –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –≤–∞–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
mkdir -p backup-untracked-$(date +%Y%m%d_%H%M%S)

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã
if [ -f "server.js.backup" ]; then
    cp server.js.backup backup-untracked-$(date +%Y%m%d_%H%M%S)/
    echo "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω server.js.backup"
fi

if [ -f "schedule.json" ]; then
    cp schedule.json backup-untracked-$(date +%Y%m%d_%H%M%S)/
    echo "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω schedule.json"
fi

if [ -f "predictions_progress_968.json" ]; then
    cp predictions_progress_968.json backup-untracked-$(date +%Y%m%d_%H%M%S)/
    echo "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω predictions_progress_968.json"
fi

# –£–¥–∞–ª—è–µ–º –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã
echo ""
echo "üßπ –£–¥–∞–ª—è–µ–º –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã..."
git clean -fd

if [ $? -eq 0 ]; then
    echo "‚úÖ –ù–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤"
    exit 1
fi

echo ""
echo "üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –≤–µ—Ç–∫—É catalog-parser..."
git checkout catalog-parser --force

if [ $? -eq 0 ]; then
    echo "‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ –≤–µ—Ç–∫—É catalog-parser"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –≤–µ—Ç–∫—É catalog-parser"
    exit 1
fi

echo ""
echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
git pull origin catalog-parser

if [ $? -eq 0 ]; then
    echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω—ã —Å GitHub"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π"
    exit 1
fi

echo ""
echo "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞..."
git status

echo ""
echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "üí° –í–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ backup-untracked-*/"
echo "üåê –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É"
