#!/bin/bash

# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Å–Ω–æ–≤–Ω—ã–º —Å–∞–π—Ç–æ–º
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ—á–µ–º—É –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∞—É–∫—Ü–∏–æ–Ω—ã

echo "üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú–´ –° –û–°–ù–û–í–ù–´–ú –°–ê–ô–¢–û–ú..."
echo "========================================="

cd /var/www/wolmar-parser

echo "üìä –≠–¢–ê–ü 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ PM2..."
echo "================================="

echo "üîç –°—Ç–∞—Ç—É—Å PM2:"
pm2 status

echo ""
echo "üìä –≠–¢–ê–ü 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∞–π—Ç–∞..."
echo "=========================================="

echo "üìã –õ–æ–≥–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∞–π—Ç–∞:"
pm2 logs wolmar-parser --lines 20

echo ""
echo "üìä –≠–¢–ê–ü 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ API –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∞–π—Ç–∞..."
echo "======================================="

echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –∑–¥–æ—Ä–æ–≤—å—è:"
curl -s http://localhost:3001/api/health | jq . 2>/dev/null || curl -s http://localhost:3001/api/health

echo ""
echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –∞—É–∫—Ü–∏–æ–Ω–æ–≤:"
curl -s http://localhost:3001/api/auctions | jq '.[0:3]' 2>/dev/null || curl -s http://localhost:3001/api/auctions | head -20

echo ""
echo "üìä –≠–¢–ê–ü 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤..."
echo "==========================="

echo "üìã –ü—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 3000-3001:"
netstat -tlnp | grep -E ":300[01]" || echo "–ü–æ—Ä—Ç—ã 3000-3001 –Ω–µ –∑–∞–Ω—è—Ç—ã"

echo ""
echo "üìä –≠–¢–ê–ü 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∞–π—Ç–∞..."
echo "==========================================="

echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ server.js:"
if [ -f "server.js" ]; then
    echo "‚úÖ server.js –Ω–∞–π–¥–µ–Ω"
    echo "üìã –†–∞–∑–º–µ—Ä: $(wc -l < server.js) —Å—Ç—Ä–æ–∫"
else
    echo "‚ùå server.js –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ public/app.js:"
if [ -f "public/app.js" ]; then
    echo "‚úÖ public/app.js –Ω–∞–π–¥–µ–Ω"
    echo "üìã –†–∞–∑–º–µ—Ä: $(wc -l < public/app.js) —Å—Ç—Ä–æ–∫"
else
    echo "‚ùå public/app.js –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ public/index.html:"
if [ -f "public/index.html" ]; then
    echo "‚úÖ public/index.html –Ω–∞–π–¥–µ–Ω"
    echo "üìã –†–∞–∑–º–µ—Ä: $(wc -l < public/index.html) —Å—Ç—Ä–æ–∫"
else
    echo "‚ùå public/index.html –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "üìä –≠–¢–ê–ü 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –≤ server.js..."
echo "=============================================="

echo "üìã –ü–æ–∏—Å–∫ API –∞—É–∫—Ü–∏–æ–Ω–æ–≤:"
grep -n "app.get.*auctions" server.js || echo "API –∞—É–∫—Ü–∏–æ–Ω–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω"

echo ""
echo "üìã –ü–æ–∏—Å–∫ API –∑–¥–æ—Ä–æ–≤—å—è:"
grep -n "app.get.*health" server.js || echo "API –∑–¥–æ—Ä–æ–≤—å—è –Ω–µ –Ω–∞–π–¥–µ–Ω"

echo ""
echo "üìã –ü–æ–∏—Å–∫ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤:"
grep -n "express.static" server.js || echo "–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"

echo ""
echo "üìä –≠–¢–ê–ü 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
echo "==============================="

echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î:"
node -e "
const { Pool } = require('pg');
const pool = new Pool({
    user: 'postgres.xkwgspqwebfeteoblayu',
    host: 'aws-0-eu-north-1.pooler.supabase.com',
    database: 'postgres',
    password: 'Gopapopa326+',
    port: 6543,
    ssl: { rejectUnauthorized: false }
});

pool.query('SELECT COUNT(*) FROM auction_lots')
    .then(result => {
        console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —Ä–∞–±–æ—Ç–∞–µ—Ç');
        console.log('üìã –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ—Ç–æ–≤:', result.rows[0].count);
        pool.end();
    })
    .catch(err => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î:', err.message);
        pool.end();
    });
"

echo ""
echo "üìä –≠–¢–ê–ü 8: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞..."
echo "====================================="

echo "üåê –í–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É —Å–∞–π—Ç—É:"
curl -s http://46.173.19.68:3001/api/health | jq . 2>/dev/null || curl -s http://46.173.19.68:3001/api/health

echo ""
echo "üåê –í–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø –∫ API –∞—É–∫—Ü–∏–æ–Ω–æ–≤:"
curl -s http://46.173.19.68:3001/api/auctions | jq '.[0:3]' 2>/dev/null || curl -s http://46.173.19.68:3001/api/auctions | head -20

echo ""
echo "üìä –≠–¢–ê–ü 9: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
echo "================================="

echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ config.js:"
if [ -f "config.js" ]; then
    echo "‚úÖ config.js –Ω–∞–π–¥–µ–Ω"
    echo "üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ config.js:"
    cat config.js
else
    echo "‚ùå config.js –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "üìä –≠–¢–ê–ü 10: –ü—Ä–æ–≤–µ—Ä–∫–∞ package.json..."
echo "=================================="

echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ package.json:"
if [ -f "package.json" ]; then
    echo "‚úÖ package.json –Ω–∞–π–¥–µ–Ω"
    echo "üìã –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:"
    grep -A 20 '"dependencies"' package.json || echo "–°–µ–∫—Ü–∏—è dependencies –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
else
    echo "‚ùå package.json –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú–´ –° –û–°–ù–û–í–ù–´–ú –°–ê–ô–¢–û–ú –ó–ê–í–ï–†–®–ï–ù–ê!"
echo "================================================="
echo "üí° –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã—à–µ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã"
echo "üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã: –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤, –ø—Ä–æ–±–ª–µ–º—ã —Å –ë–î, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è"
