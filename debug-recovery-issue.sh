#!/bin/bash

# –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø–∞—Ä—Å–µ—Ä–æ–≤
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–∞–π–ª—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –ª–æ–≥–∏

echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø–∞—Ä—Å–µ—Ä–æ–≤..."
echo "=================================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "server.js" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ wolmar-parser"
    exit 1
fi

echo "üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞..."
echo "================================"

# –ò—â–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
echo "üîç –ò—â–µ–º —Ñ–∞–π–ª—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:"
find . -name "*progress*.json" -type f 2>/dev/null | head -10

echo ""
echo "üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
ls -la *.json 2>/dev/null || echo "‚ùå JSON —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

echo ""
echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ PM2..."
echo "========================"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ PM2
echo "üîç –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ PM2:"
pm2 logs wolmar-parser --lines 20 --nostream 2>/dev/null || echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ PM2"

echo ""
echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å PM2..."
echo "=========================="
pm2 status

echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã..."
echo "============================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏
echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–≥–∞—Ö:"
tail -20 /var/log/wolmar-auto-restart.log 2>/dev/null || echo "‚ùå –õ–æ–≥–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

echo ""
echo "üß™ –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞..."
echo "====================================="

# –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
cat > test_parser_progress_2133.json << EOF
{
    "auctionNumber": "2133",
    "currentLot": 150,
    "progress": 75.5,
    "totalLots": 200,
    "lastUpdate": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
}
EOF

cat > test_mass_update_progress_968.json << EOF
{
    "auctionNumber": "968",
    "updateProgress": {
        "currentLot": 200,
        "progress": 80.0,
        "totalLots": 250
    },
    "lastUpdate": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
}
EOF

echo "‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã"

echo ""
echo "üîç –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑ —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏..."
echo "==========================================="

# –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
node analyze-crash-recovery.js

echo ""
echo "üìÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç—á–µ—Ç..."
if [ -f "crash-recovery-report.json" ]; then
    echo "‚úÖ –û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω:"
    cat crash-recovery-report.json | jq . 2>/dev/null || cat crash-recovery-report.json
else
    echo "‚ùå –û—Ç—á–µ—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω"
fi

echo ""
echo "üßπ –û—á–∏—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã..."
rm -f test_*.json crash-recovery-report.json

echo ""
echo "üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
echo "================"
echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞—Ä—Å–µ—Ä —Å–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞"
echo "2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞"
echo "4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞—Ä—Å–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞"
