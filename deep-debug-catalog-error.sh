#!/bin/bash

# –ì–ª—É–±–æ–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–∫–∏ MODULE_NOT_FOUND –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
# –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–∫–∏

echo "üîç –ì–õ–£–ë–û–ö–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –û–®–ò–ë–ö–ò MODULE_NOT_FOUND..."
echo "==============================================="

cd /var/www/catalog-interface

echo "üìä –≠–¢–ê–ü 1: –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä–æ–∫–∏ 48 –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞..."
echo "========================================"

if [ -f "server.js" ]; then
    echo "üìã –°—Ç—Ä–æ–∫–∞ 48:"
    sed -n '48p' server.js
    echo ""
    echo "üìã –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ç—Ä–æ–∫–∏ 48 (—Å—Ç—Ä–æ–∫–∏ 45-50):"
    sed -n '45,50p' server.js
    echo ""
    echo "üìã –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ç—Ä–æ–∫–∏ 48 (—Å—Ç—Ä–æ–∫–∏ 40-55):"
    sed -n '40,55p' server.js
else
    echo "‚ùå server.js –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

echo ""
echo "üìä –≠–¢–ê–ü 2: –ü–æ–∏—Å–∫ –≤—Å–µ—Ö require() –≤ —Ñ–∞–π–ª–µ..."
echo "========================================"

echo "üìã –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã —Å –Ω–æ–º–µ—Ä–∞–º–∏ —Å—Ç—Ä–æ–∫:"
grep -n "require(" server.js

echo ""
echo "üìä –≠–¢–ê–ü 3: –ê–Ω–∞–ª–∏–∑ package.json..."
echo "==============================="

if [ -f "package.json" ]; then
    echo "üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ package.json:"
    cat package.json
    echo ""
    echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:"
    if [ -f "package.json" ]; then
        echo "üìã –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ package.json:"
        grep -A 20 '"dependencies"' package.json || echo "–°–µ–∫—Ü–∏—è dependencies –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    fi
else
    echo "‚ùå package.json –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "üìä –≠–¢–ê–ü 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ node_modules..."
echo "================================="

if [ -d "node_modules" ]; then
    echo "‚úÖ node_modules –Ω–∞–π–¥–µ–Ω"
    echo "üìã –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–¥—É–ª–µ–π: $(ls node_modules | wc -l)"
    echo "üìã –û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥—É–ª–∏:"
    ls node_modules | head -20
    echo ""
    echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –º–æ–¥—É–ª–µ–π:"
    for module in "express" "cors" "pg" "path"; do
        if [ -d "node_modules/$module" ]; then
            echo "‚úÖ $module –Ω–∞–π–¥–µ–Ω"
            echo "üìã –í–µ—Ä—Å–∏—è $module:"
            if [ -f "node_modules/$module/package.json" ]; then
                grep '"version"' node_modules/$module/package.json || echo "–í–µ—Ä—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            fi
        else
            echo "‚ùå $module –Ω–µ –Ω–∞–π–¥–µ–Ω"
        fi
    done
else
    echo "‚ùå node_modules –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "üìä –≠–¢–ê–ü 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
echo "======================================="

echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ config.js:"
if [ -f "config.js" ]; then
    echo "‚úÖ config.js –Ω–∞–π–¥–µ–Ω"
    echo "üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ config.js:"
    cat config.js
else
    echo "‚ùå config.js –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—Ä—É–≥–∏—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:"
for file in "config.production.js" "config.example.js" ".env" ".env.local"; do
    if [ -f "$file" ]; then
        echo "‚úÖ $file –Ω–∞–π–¥–µ–Ω"
    else
        echo "‚ùå $file –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi
done

echo ""
echo "üìä –≠–¢–ê–ü 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞..."
echo "=================================="

echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ server.js:"
node -c server.js 2>&1

echo ""
echo "üìã –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ server.js (10 —Å–µ–∫—É–Ω–¥):"
timeout 10 node server.js 2>&1 || echo "–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω –ø–æ —Ç–∞–π–º–∞—É—Ç—É –∏–ª–∏ —Å –æ—à–∏–±–∫–æ–π"

echo ""
echo "üìä –≠–¢–ê–ü 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Node.js –∏ npm..."
echo "========================================"

echo "üìã –í–µ—Ä—Å–∏—è Node.js:"
node --version

echo "üìã –í–µ—Ä—Å–∏—è npm:"
npm --version

echo "üìã –í–µ—Ä—Å–∏—è PM2:"
pm2 --version

echo ""
echo "üìä –≠–¢–ê–ü 8: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
echo "================================="

echo "üìã –ü—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª—ã:"
ls -la server.js package.json config.js 2>/dev/null || echo "–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

echo "üìã –ü—Ä–∞–≤–∞ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
ls -la . | head -10

echo ""
echo "üìä –≠–¢–ê–ü 9: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
echo "======================================="

echo "üìã –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
env | grep -E "(NODE|PATH|HOME)" | head -10

echo ""
echo "üìä –≠–¢–ê–ü 10: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Node.js..."
echo "====================================="

echo "üìã –ü—Ä–æ—Ü–µ—Å—Å—ã Node.js:"
ps aux | grep node | grep -v grep || echo "–ü—Ä–æ—Ü–µ—Å—Å—ã Node.js –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

echo ""
echo "üìä –≠–¢–ê–ü 11: –ü—Ä–æ–≤–µ—Ä–∫–∞ PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
echo "=================================="

echo "üìã –°—Ç–∞—Ç—É—Å PM2:"
pm2 status

echo "üìã –õ–æ–≥–∏ PM2:"
pm2 logs --lines 5

echo ""
echo "üìä –≠–¢–ê–ü 12: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤..."
echo "============================"

echo "üìã –ü—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 3000-3001:"
netstat -tlnp | grep -E ":300[01]" || echo "–ü–æ—Ä—Ç—ã 3000-3001 –Ω–µ –∑–∞–Ω—è—Ç—ã"

echo ""
echo "üìä –≠–¢–ê–ü 13: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –∫–∞—Ç–∞–ª–æ–≥–∞..."
echo "==================================="

echo "üìã –õ–æ–≥–∏ –∫–∞—Ç–∞–ª–æ–≥–∞:"
pm2 logs catalog-interface --lines 20 2>/dev/null || echo "–õ–æ–≥–∏ –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

echo ""
echo "üìä –≠–¢–ê–ü 14: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ server.js –ø–æ —á–∞—Å—Ç—è–º..."
echo "==================================================="

echo "üìã –ü–µ—Ä–≤—ã–µ 20 —Å—Ç—Ä–æ–∫ server.js:"
head -20 server.js

echo ""
echo "üìã –°—Ç—Ä–æ–∫–∏ 40-60 server.js:"
sed -n '40,60p' server.js

echo ""
echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫ server.js:"
tail -20 server.js

echo ""
echo "üìä –≠–¢–ê–ü 15: –ü–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å—Ç—Ä–æ–∫..."
echo "=================================="

echo "üìã –ü–æ–∏—Å–∫ —Å—Ç—Ä–æ–∫ —Å 'require':"
grep -n "require" server.js

echo ""
echo "üìã –ü–æ–∏—Å–∫ —Å—Ç—Ä–æ–∫ —Å 'import':"
grep -n "import" server.js

echo ""
echo "üìã –ü–æ–∏—Å–∫ —Å—Ç—Ä–æ–∫ —Å 'module':"
grep -n "module" server.js

echo ""
echo "üìä –≠–¢–ê–ü 16: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ package.json..."
echo "================================================"

if [ -f "package.json" ]; then
    echo "üìã –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:"
    grep -A 50 '"dependencies"' package.json || echo "–°–µ–∫—Ü–∏—è dependencies –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    
    echo "üìã Dev –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:"
    grep -A 50 '"devDependencies"' package.json || echo "–°–µ–∫—Ü–∏—è devDependencies –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi

echo ""
echo "üìä –≠–¢–ê–ü 17: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤..."
echo "=========================================="

echo "üìã –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã:"
npm list --depth=0 2>/dev/null || echo "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤"

echo ""
echo "üìä –≠–¢–ê–ü 18: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ npm..."
echo "=============================="

echo "üìã –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ npm:"
npm cache clean --force

echo ""
echo "üìä –≠–¢–ê–ü 19: –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
echo "======================================"

echo "üìã –£–¥–∞–ª–µ–Ω–∏–µ node_modules:"
rm -rf node_modules package-lock.json

echo "üìã –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:"
npm install

echo ""
echo "üìä –≠–¢–ê–ü 20: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞..."
echo "=============================="

echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏:"
node -c server.js 2>&1

echo "üìã –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏ (5 —Å–µ–∫—É–Ω–¥):"
timeout 5 node server.js 2>&1 || echo "–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω –ø–æ —Ç–∞–π–º–∞—É—Ç—É –∏–ª–∏ —Å –æ—à–∏–±–∫–æ–π"

echo ""
echo "‚úÖ –ì–õ–£–ë–û–ö–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!"
echo "================================="
echo "üí° –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã—à–µ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã"
echo "üí° –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –≤–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å server.js —Å –Ω—É–ª—è"
