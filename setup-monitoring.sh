#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–µ—Ä–≤–µ—Ä–∞

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–µ—Ä–≤–µ—Ä–∞..."

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤
mkdir -p /var/log

# –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x auto-restart.sh

# –î–æ–±–∞–≤–ª—è–µ–º –≤ cron –∑–∞–¥–∞—á—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
echo "üìÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron –∑–∞–¥–∞—á–∏..."

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å cron –∑–∞–¥–∞—á–µ–π
cat > /tmp/wolmar-monitor-cron << EOF
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ä–≤–µ—Ä–∞ wolmar-parser
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
*/5 * * * * /var/www/wolmar-parser/auto-restart.sh

# –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ (—Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π)
0 2 * * * find /var/log -name "wolmar-auto-restart.log*" -mtime +7 -delete
EOF

# –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ cron (–µ—Å–ª–∏ –µ—ë –µ—â–µ –Ω–µ—Ç)
if ! crontab -l 2>/dev/null | grep -q "wolmar-parser/auto-restart.sh"; then
    (crontab -l 2>/dev/null; cat /tmp/wolmar-monitor-cron) | crontab -
    echo "‚úÖ Cron –∑–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞"
else
    echo "‚ö†Ô∏è Cron –∑–∞–¥–∞—á–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
rm /tmp/wolmar-monitor-cron

echo "üéØ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìã –ß—Ç–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ:"
echo "  ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç"
echo "  ‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ —Å–±–æ—è—Ö"
echo "  ‚Ä¢ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ /var/log/wolmar-auto-restart.log"
echo "  ‚Ä¢ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤"
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å cron –∑–∞–¥–∞—á–∏: crontab -l"
echo "üìä –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏: tail -f /var/log/wolmar-auto-restart.log"
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: crontab -e (—É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É —Å auto-restart.sh)"
