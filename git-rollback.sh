#!/bin/bash

# Wolmar Parser - Git Rollback Script
# –ê–≤—Ç–æ—Ä: Wolmar Team
# –í–µ—Ä—Å–∏—è: 2.0.0

set -e

echo "‚è™ –û—Ç–∫–∞—Ç Wolmar Parser –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
if [ ! -d .git ]; then
    echo "‚ùå –≠—Ç–æ –Ω–µ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π!"
    exit 1
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∫–æ–º–º–∏—Ç–æ–≤
echo "üìã –ò—Å—Ç–æ—Ä–∏—è –∫–æ–º–º–∏—Ç–æ–≤:"
git log --oneline -10

# –°–ø—Ä–∞—à–∏–≤–∞–µ–º, –∫ –∫–∞–∫–æ–º—É –∫–æ–º–º–∏—Ç—É –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è
echo ""
echo "üîç –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–º–∏—Ç –¥–ª—è –æ—Ç–∫–∞—Ç–∞:"
echo "1. –ü—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–º–º–∏—Ç (HEAD~1)"
echo "2. –î–≤–∞ –∫–æ–º–º–∏—Ç–∞ –Ω–∞–∑–∞–¥ (HEAD~2)"
echo "3. –¢—Ä–∏ –∫–æ–º–º–∏—Ç–∞ –Ω–∞–∑–∞–¥ (HEAD~3)"
echo "4. –í–≤–µ—Å—Ç–∏ —Ö–µ—à –∫–æ–º–º–∏—Ç–∞ –≤—Ä—É—á–Ω—É—é"
echo "5. –û—Ç–º–µ–Ω–∞"

read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä (1-5): " choice

case $choice in
    1)
        COMMIT="HEAD~1"
        ;;
    2)
        COMMIT="HEAD~2"
        ;;
    3)
        COMMIT="HEAD~3"
        ;;
    4)
        read -p "–í–≤–µ–¥–∏—Ç–µ —Ö–µ—à –∫–æ–º–º–∏—Ç–∞: " COMMIT
        ;;
    5)
        echo "‚ùå –û—Ç–∫–∞—Ç –æ—Ç–º–µ–Ω–µ–Ω"
        exit 0
        ;;
    *)
        echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
        exit 1
        ;;
esac

# –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è..."
BACKUP_DIR="backup/rollback-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$BACKUP_DIR"

# –ö–æ–ø–∏—Ä—É–µ–º –≤–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã
cp .env "$BACKUP_DIR/" 2>/dev/null || true
cp ecosystem.config.js "$BACKUP_DIR/" 2>/dev/null || true

echo "üì¶ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω –≤: $BACKUP_DIR"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
pm2 stop all

# –í—ã–ø–æ–ª–Ω—è–µ–º –æ—Ç–∫–∞—Ç
echo "‚è™ –û—Ç–∫–∞—Ç –∫ –∫–æ–º–º–∏—Ç—É: $COMMIT"
git reset --hard "$COMMIT"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm install --production

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
pm2 start ecosystem.config.js

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π:"
pm2 status

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
pm2 logs --lines 10

echo "‚úÖ –û—Ç–∫–∞—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
echo "üåê –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä: http://localhost:3001"
echo "üìö –ö–∞—Ç–∞–ª–æ–≥: http://localhost:3000"
echo ""
echo "üìã –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  pm2 status          - —Å—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π"
echo "  pm2 logs            - –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤"
echo "  pm2 restart all     - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π"
echo "  pm2 monit           - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"
