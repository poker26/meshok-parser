#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะพะฑะฝะพะฒะปะตะฝะธั ัะตัะฒะตัะฐ wolmar-parser
# ะะฒัะพะผะฐัะธัะตัะบะธ ะฒัะฟะพะปะฝัะตั: git pull, pm2 restart, ะฟัะพะฒะตัะบั ััะฐัััะฐ

echo "๐ ะะฑะฝะพะฒะปะตะฝะธะต ัะตัะฒะตัะฐ wolmar-parser..."
echo "=================================="

# ะัะพะฒะตััะตะผ, ััะพ ะผั ะฒ ะฟัะฐะฒะธะปัะฝะพะน ะดะธัะตะบัะพัะธะธ
if [ ! -f "server.js" ]; then
    echo "โ ะัะธะฑะบะฐ: ะกะบัะธะฟั ะดะพะปะถะตะฝ ะทะฐะฟััะบะฐัััั ะธะท ะดะธัะตะบัะพัะธะธ wolmar-parser"
    echo "๐ก ะะตัะตะนะดะธัะต ะฒ ะดะธัะตะบัะพัะธั: cd /var/www/wolmar-parser"
    exit 1
fi

# ะะพะบะฐะทัะฒะฐะตะผ ัะตะบััะธะน ััะฐััั
echo "๐ ะขะตะบััะธะน ััะฐััั PM2:"
pm2 status

echo ""
echo "๐ ะัะฟะพะปะฝัะตะผ git pull..."
git pull origin catalog-parser

if [ $? -eq 0 ]; then
    echo "โ Git pull ะฒัะฟะพะปะฝะตะฝ ััะฟะตัะฝะพ"
else
    echo "โ ะัะธะฑะบะฐ ะฟัะธ ะฒัะฟะพะปะฝะตะฝะธะธ git pull"
    exit 1
fi

echo ""
echo "๐ ะะตัะตะทะฐะฟััะบะฐะตะผ PM2 ะฟัะพัะตัั..."
pm2 restart wolmar-parser

if [ $? -eq 0 ]; then
    echo "โ PM2 ะฟัะพัะตัั ะฟะตัะตะทะฐะฟััะตะฝ ััะฟะตัะฝะพ"
else
    echo "โ ะัะธะฑะบะฐ ะฟัะธ ะฟะตัะตะทะฐะฟััะบะต PM2"
    exit 1
fi

echo ""
echo "โณ ะะดะตะผ 3 ัะตะบัะฝะดั ะดะปั ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ..."
sleep 3

echo ""
echo "๐ ะัะพะฒะตััะตะผ ััะฐััั ะฟะพัะปะต ะพะฑะฝะพะฒะปะตะฝะธั:"
pm2 status

echo ""
echo "๐ฅ ะัะพะฒะตััะตะผ ะทะดะพัะพะฒัะต ัะตัะฒะตัะฐ..."
curl -s http://localhost:3001/api/health | jq . 2>/dev/null || echo "โ ะกะตัะฒะตั ะฝะต ะพัะฒะตัะฐะตั ะธะปะธ jq ะฝะต ัััะฐะฝะพะฒะปะตะฝ"

echo ""
echo "โ ะะฑะฝะพะฒะปะตะฝะธะต ะทะฐะฒะตััะตะฝะพ!"
echo "๐ ะกะตัะฒะตั ะดะพัััะฟะตะฝ ะฟะพ ะฐะดัะตัั: http://46.173.19.68:3001"
echo "๐ ะะพะฝะธัะพัะธะฝะณ: http://46.173.19.68:3001/monitor"
echo "โ๏ธ ะะดะผะธะฝ ะฟะฐะฝะตะปั: http://46.173.19.68:3001/admin"
