#!/bin/bash

# –ì–ª—É–±–æ–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–∞—Ç–∞–ª–æ–≥–æ–º
# –í—ã—è—Å–Ω—è–µ—Ç —á—Ç–æ –∏–º–µ–Ω–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

echo "üîç –ì–õ–£–ë–û–ö–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú–´..."
echo "=================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
if [ ! -f "/var/www/wolmar-parser/server.js" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ /var/www/wolmar-parser"
    exit 1
fi

cd /var/www/wolmar-parser

echo "üìä –≠–¢–ê–ü 1: –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã..."
echo "====================================="

echo "üîç –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:"
pwd

echo ""
echo "üîç –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞ Git:"
git branch --show-current

echo ""
echo "üîç –°—Ç–∞—Ç—É—Å Git:"
git status --porcelain

echo ""
echo "üîç PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã:"
pm2 status

echo ""
echo "üîç –ü—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç–∞—Ö:"
netstat -tlnp | grep -E ":(3000|3001)"

echo ""
echo "üîç –í—Å–µ Node.js –ø—Ä–æ—Ü–µ—Å—Å—ã:"
ps aux | grep node | grep -v grep

echo ""
echo "üìä –≠–¢–ê–ü 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø–æ—Ä—Ç–æ–≤..."
echo "======================================"

echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞ 3001 (–æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä):"
echo "üìã HTTP —Å—Ç–∞—Ç—É—Å:"
curl -I http://localhost:3001/ 2>/dev/null | head -1 || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"

echo "üìã –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:"
curl -s http://localhost:3001/ | grep -o '<title>.*</title>' || echo "–ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω"

echo "üìã API health:"
curl -s http://localhost:3001/api/health || echo "API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"

echo ""
echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞ 3000 (–∫–∞—Ç–∞–ª–æ–≥):"
echo "üìã HTTP —Å—Ç–∞—Ç—É—Å:"
curl -I http://localhost:3000/ 2>/dev/null | head -1 || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"

echo "üìã –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:"
curl -s http://localhost:3000/ | grep -o '<title>.*</title>' || echo "–ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω"

echo "üìã API –∫–∞—Ç–∞–ª–æ–≥–∞:"
curl -s http://localhost:3000/api/auctions || echo "API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"

echo ""
echo "üìä –≠–¢–ê–ü 3: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ..."
echo "================================="

echo "üìã –ü–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫ –ø–æ—Ä—Ç–∞ 3001:"
curl -s http://localhost:3001/ | head -10

echo ""
echo "üìã –ü–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫ –ø–æ—Ä—Ç–∞ 3000:"
curl -s http://localhost:3000/ | head -10

echo ""
echo "üìä –≠–¢–ê–ü 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –∫–∞—Ç–∞–ª–æ–≥–∞..."
echo "==================================="

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∫–∞—Ç–∞–ª–æ–≥–∞:"
ls -la /var/www/catalog-interface/ 2>/dev/null || echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"

echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ server.js –∫–∞—Ç–∞–ª–æ–≥–∞:"
if [ -f "/var/www/catalog-interface/server.js" ]; then
    echo "‚úÖ server.js –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–∞–π–¥–µ–Ω"
    echo "üìã –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $(wc -l < /var/www/catalog-interface/server.js) —Å—Ç—Ä–æ–∫"
    echo "üìã –ü–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫:"
    head -5 /var/www/catalog-interface/server.js
    echo "üìã –ü–æ–∏—Å–∫ –ø–æ—Ä—Ç–∞ 3000:"
    grep -n "3000" /var/www/catalog-interface/server.js || echo "–ü–æ—Ä—Ç 3000 –Ω–µ –Ω–∞–π–¥–µ–Ω"
else
    echo "‚ùå server.js –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ package.json –∫–∞—Ç–∞–ª–æ–≥–∞:"
if [ -f "/var/www/catalog-interface/package.json" ]; then
    echo "‚úÖ package.json –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–∞–π–¥–µ–Ω"
    echo "üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
    cat /var/www/catalog-interface/package.json
else
    echo "‚ùå package.json –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "üìä –≠–¢–ê–ü 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤..."
echo "=========================="

echo "üìã –õ–æ–≥–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞:"
pm2 logs wolmar-parser --lines 5 2>/dev/null || echo "–õ–æ–≥–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

echo ""
echo "üìã –õ–æ–≥–∏ –∫–∞—Ç–∞–ª–æ–≥–∞:"
pm2 logs catalog-interface --lines 5 2>/dev/null || echo "–õ–æ–≥–∏ –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

echo ""
echo "üìä –≠–¢–ê–ü 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
echo "================================="

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ config.js –∫–∞—Ç–∞–ª–æ–≥–∞:"
if [ -f "/var/www/catalog-interface/config.js" ]; then
    echo "‚úÖ config.js –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–∞–π–¥–µ–Ω"
    echo "üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
    cat /var/www/catalog-interface/config.js
else
    echo "‚ùå config.js –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "üìä –≠–¢–ê–ü 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
echo "================================="

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ node_modules –∫–∞—Ç–∞–ª–æ–≥–∞:"
if [ -d "/var/www/catalog-interface/node_modules" ]; then
    echo "‚úÖ node_modules –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–∞–π–¥–µ–Ω"
    echo "üìã –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–¥—É–ª–µ–π: $(ls /var/www/catalog-interface/node_modules | wc -l)"
else
    echo "‚ùå node_modules –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "üìä –≠–¢–ê–ü 8: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞..."
echo "========================================"

echo "üîç –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞ –≤—Ä—É—á–Ω—É—é:"
cd /var/www/catalog-interface 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∫–∞—Ç–∞–ª–æ–≥–∞"

if [ -f "server.js" ]; then
    echo "üìã –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞:"
    node -c server.js 2>&1 || echo "–û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞"
    
    echo "üìã –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ (5 —Å–µ–∫—É–Ω–¥):"
    timeout 5 node server.js 2>&1 || echo "–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω –ø–æ —Ç–∞–π–º–∞—É—Ç—É –∏–ª–∏ —Å –æ—à–∏–±–∫–æ–π"
else
    echo "‚ùå server.js –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo ""
echo "üìä –≠–¢–ê–ü 9: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞..."
echo "===================================="

echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ—Ä—Ç—É 3001:"
curl -I http://46.173.19.68:3001/ 2>/dev/null | head -1 || echo "–í–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Ä—Ç—É 3001 –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ—Ä—Ç—É 3000:"
curl -I http://46.173.19.68:3000/ 2>/dev/null | head -1 || echo "–í–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Ä—Ç—É 3000 –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

echo ""
echo "‚úÖ –ì–õ–£–ë–û–ö–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!"
echo "================================="
echo "üí° –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã—à–µ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã"
echo "üí° –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ—è—Å–Ω–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ ./radical-fix-catalog.sh"
