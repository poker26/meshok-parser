#!/bin/bash

# ะะฐะฟััะบ ะพัะฝะพะฒะฝะพะณะพ ัะฐะนัะฐ ะฟะพัะปะต ัะตััะธัะพะฒะฐะฝะธั ะบะฐัะฐะปะพะณะฐ
# ะะฐะฟััะบะฐะตั ะพัะฝะพะฒะฝะพะน ัะตัะฒะตั ะฝะฐ ะฟะพััั 3001

echo "๐ ะะะะฃะกะ ะะกะะะะะะะ ะกะะะขะ..."
echo "==========================="

# ะัะพะฒะตััะตะผ, ััะพ ะผั ะฝะฐ ัะตัะฒะตัะต
if [ ! -f "/var/www/wolmar-parser/server.js" ]; then
    echo "โ ะัะธะฑะบะฐ: ะกะบัะธะฟั ะดะพะปะถะตะฝ ะทะฐะฟััะบะฐัััั ะฝะฐ ัะตัะฒะตัะต ะฒ /var/www/wolmar-parser"
    exit 1
fi

cd /var/www/wolmar-parser

echo "๐ ะญะขะะ 1: ะัะพะฒะตัะบะฐ ัะตะบััะตะณะพ ััะฐัััะฐ..."
echo "===================================="

echo "๐ ะกัะฐััั PM2:"
pm2 status

echo ""
echo "๐ ะัะพัะตััั ะฝะฐ ะฟะพััะฐั:"
netstat -tlnp | grep -E ":(3000|3001|3002)"

echo ""
echo "๐ ะญะขะะ 2: ะะพะดะณะพัะพะฒะบะฐ ะพัะฝะพะฒะฝะพะณะพ ัะตัะฒะตัะฐ..."
echo "======================================"

echo "๐ ะะตัะตะบะปััะตะฝะธะต ะฝะฐ ะพัะฝะพะฒะฝัั ะฒะตัะบั..."
git checkout catalog-parser --force
git pull origin catalog-parser

echo ""
echo "๐ ะญะขะะ 3: ะะฐะฟััะบ ะพัะฝะพะฒะฝะพะณะพ ัะตัะฒะตัะฐ..."
echo "=================================="

echo "๐ ะะฐะฟััะบ ะพัะฝะพะฒะฝะพะณะพ ัะตัะฒะตัะฐ ะฝะฐ ะฟะพััั 3001..."
pm2 start ecosystem.config.js

if [ $? -eq 0 ]; then
    echo "โ ะัะฝะพะฒะฝะพะน ัะตัะฒะตั ะทะฐะฟััะตะฝ ัะตัะตะท PM2"
else
    echo "โ ะัะธะฑะบะฐ ะทะฐะฟััะบะฐ ะพัะฝะพะฒะฝะพะณะพ ัะตัะฒะตัะฐ"
    exit 1
fi

echo ""
echo "โณ ะญะขะะ 4: ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ ะพัะฝะพะฒะฝะพะณะพ ัะตัะฒะตัะฐ..."
sleep 5

echo ""
echo "๐ ะญะขะะ 5: ะัะพะฒะตัะบะฐ ัะฐะฑะพัั ัะธััะตะผั..."
echo "================================="

echo "๐ ะกัะฐััั PM2:"
pm2 status

echo ""
echo "๐ ะัะพัะตััั ะฝะฐ ะฟะพััะฐั:"
netstat -tlnp | grep -E ":(3000|3001|3002)"

echo ""
echo "๐ ะขะตััะธัะพะฒะฐะฝะธะต ะพัะฝะพะฒะฝะพะณะพ ัะตัะฒะตัะฐ (ะฟะพัั 3001):"
curl -s http://localhost:3001/api/health > /dev/null
if [ $? -eq 0 ]; then
    echo "โ ะัะฝะพะฒะฝะพะน ัะตัะฒะตั ัะฐะฑะพัะฐะตั ะฝะฐ ะฟะพััั 3001"
    echo "๐ ะะพัััะฟะตะฝ: http://46.173.19.68:3001"
else
    echo "โ ะัะฝะพะฒะฝะพะน ัะตัะฒะตั ะฝะต ัะฐะฑะพัะฐะตั"
    echo "๐ ะะพะณะธ ะพัะฝะพะฒะฝะพะณะพ ัะตัะฒะตัะฐ:"
    pm2 logs wolmar-parser --lines 10
fi

echo ""
echo "๐ ะขะตััะธัะพะฒะฐะฝะธะต ะบะฐัะฐะปะพะณะฐ (ะฟะพัั 3000):"
curl -s http://localhost:3000/api/test > /dev/null
if [ $? -eq 0 ]; then
    echo "โ ะะฐัะฐะปะพะณ ะผะพะฝะตั ัะฐะฑะพัะฐะตั ะฝะฐ ะฟะพััั 3000"
    echo "๐ ะะพัััะฟะตะฝ: http://46.173.19.68:3000"
else
    echo "โ ะะฐัะฐะปะพะณ ะผะพะฝะตั ะฝะต ัะฐะฑะพัะฐะตั"
    echo "๐ ะะพะณะธ ะบะฐัะฐะปะพะณะฐ:"
    pm2 logs catalog-interface --lines 10
fi

echo ""
echo "๐ ะกัะฐะฒะฝะตะฝะธะต ัะพะดะตัะถะธะผะพะณะพ ะฟะพััะพะฒ:"
echo "๐ ะะตัะฒัะต 3 ัััะพะบะธ ะฟะพััะฐ 3001 (ะพัะฝะพะฒะฝะพะน ัะตัะฒะตั):"
curl -s http://localhost:3001/ | head -3

echo ""
echo "๐ ะะตัะฒัะต 3 ัััะพะบะธ ะฟะพััะฐ 3000 (ะบะฐัะฐะปะพะณ):"
curl -s http://localhost:3000/ | head -3

echo ""
echo "โ ะะกะะะะะะ ะกะะะข ะะะะฃะฉะะ!"
echo "============================================="
echo "๐ ะัะฝะพะฒะฝะพะน ัะตัะฒะตั: http://46.173.19.68:3001"
echo "๐ ะะฐัะฐะปะพะณ ะผะพะฝะตั: http://46.173.19.68:3000"
echo "๐ ะะพะฝะธัะพัะธะฝะณ: pm2 status"
echo "๐ ะะพะณะธ ะพัะฝะพะฒะฝะพะณะพ ัะตัะฒะตัะฐ: pm2 logs wolmar-parser"
echo "๐ ะะพะณะธ ะบะฐัะฐะปะพะณะฐ: pm2 logs catalog-interface"
