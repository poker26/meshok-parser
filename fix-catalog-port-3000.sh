#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–∞—Ç–∞–ª–æ–≥–æ–º –º–æ–Ω–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 3000
# –†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É "Connection refused"

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–∞—Ç–∞–ª–æ–≥–æ–º –º–æ–Ω–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 3000..."
echo "======================================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
if [ ! -f "/var/www/wolmar-parser/server.js" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ /var/www/wolmar-parser"
    exit 1
fi

cd /var/www/wolmar-parser

echo "üìä –≠–¢–ê–ü 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞..."
pm2 status

echo ""
echo "üîç –≠–¢–ê–ü 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞ –ø–æ—Ä—Ç—É 3000..."
netstat -tlnp | grep :3000

echo ""
echo "üåê –≠–¢–ê–ü 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–∞—Ç–∞–ª–æ–≥–∞..."
curl -s http://localhost:3000/api/auctions
if [ $? -eq 0 ]; then
    echo "‚úÖ –ö–∞—Ç–∞–ª–æ–≥ –º–æ–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç"
    exit 0
else
    echo "‚ùå –ö–∞—Ç–∞–ª–æ–≥ –º–æ–Ω–µ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
fi

echo ""
echo "üîÑ –≠–¢–ê–ü 4: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –≤–µ—Ç–∫—É web-interface..."
git checkout web-interface --force

if [ $? -eq 0 ]; then
    echo "‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ –≤–µ—Ç–∫—É web-interface"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –≤–µ—Ç–∫—É web-interface"
    exit 1
fi

echo ""
echo "üì¶ –≠–¢–ê–ü 5: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∫–∞—Ç–∞–ª–æ–≥–∞..."
mkdir -p /var/www/catalog-interface
cd /var/www/catalog-interface

echo ""
echo "üìã –≠–¢–ê–ü 6: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∫–∞—Ç–∞–ª–æ–≥–∞..."
cp -r /var/www/wolmar-parser/public/ ./
cp /var/www/wolmar-parser/server.js ./
cp /var/www/wolmar-parser/package.json ./
cp /var/www/wolmar-parser/package-lock.json ./
cp /var/www/wolmar-parser/config.example.js ./

echo "‚úÖ –§–∞–π–ª—ã –∫–∞—Ç–∞–ª–æ–≥–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"

echo ""
echo "‚öôÔ∏è –≠–¢–ê–ü 7: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞..."
cp config.example.js config.js

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ config.js –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ë–î..."
if grep -q "postgres.xkwgspqwebfeteoblayu" config.js; then
    echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ë–î –Ω–∞–π–¥–µ–Ω–∞"
else
    echo "‚ö†Ô∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ë–î –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Å–æ–∑–¥–∞–µ–º..."
    cat > config.js << 'EOF'
module.exports = {
    dbConfig: {
        user: 'postgres.xkwgspqwebfeteoblayu',
        host: 'aws-0-eu-north-1.pooler.supabase.com',
        database: 'postgres',
        password: 'Gopapopa326+',
        port: 6543,
        ssl: {
            rejectUnauthorized: false
        }
    }
};
EOF
    echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ë–î —Å–æ–∑–¥–∞–Ω–∞"
fi

echo ""
echo "üì¶ –≠–¢–ê–ü 8: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∫–∞—Ç–∞–ª–æ–≥–∞..."
npm install

if [ $? -eq 0 ]; then
    echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∫–∞—Ç–∞–ª–æ–≥–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∫–∞—Ç–∞–ª–æ–≥–∞"
    exit 1
fi

echo ""
echo "üîÑ –≠–¢–ê–ü 9: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∫–∞—Ç–∞–ª–æ–≥–∞..."
pm2 stop catalog-interface 2>/dev/null || true
pm2 delete catalog-interface 2>/dev/null || true

echo ""
echo "üöÄ –≠–¢–ê–ü 10: –ó–∞–ø—É—Å–∫ –∫–∞—Ç–∞–ª–æ–≥–∞ –º–æ–Ω–µ—Ç..."
pm2 start server.js --name "catalog-interface"

if [ $? -eq 0 ]; then
    echo "‚úÖ –ö–∞—Ç–∞–ª–æ–≥ –º–æ–Ω–µ—Ç –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ PM2"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞ –º–æ–Ω–µ—Ç"
    exit 1
fi

echo ""
echo "‚è≥ –≠–¢–ê–ü 11: –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞..."
sleep 5

echo ""
echo "üîç –≠–¢–ê–ü 12: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –∫–∞—Ç–∞–ª–æ–≥–∞..."
curl -s http://localhost:3000/api/auctions > /dev/null
if [ $? -eq 0 ]; then
    echo "‚úÖ –ö–∞—Ç–∞–ª–æ–≥ –º–æ–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 3000"
else
    echo "‚ùå –ö–∞—Ç–∞–ª–æ–≥ –º–æ–Ω–µ—Ç –≤—Å–µ –µ—â–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
    echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –∫–∞—Ç–∞–ª–æ–≥–∞..."
    pm2 logs catalog-interface --lines 20
fi

echo ""
echo "üìä –≠–¢–ê–ü 13: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ PM2..."
pm2 status

echo ""
echo "üåê –≠–¢–ê–ü 14: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞..."
curl -s http://46.173.19.68:3000/api/auctions > /dev/null
if [ $? -eq 0 ]; then
    echo "‚úÖ –ö–∞—Ç–∞–ª–æ–≥ –º–æ–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ: http://46.173.19.68:3000"
else
    echo "‚ùå –ö–∞—Ç–∞–ª–æ–≥ –º–æ–Ω–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ"
    echo "üí° –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å —Ñ–∞–π—Ä–≤–æ–ª–æ–º –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —Å–µ—Ç–∏"
fi

echo ""
echo "‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–¢–ê–õ–û–ì–ê –ó–ê–í–ï–†–®–ï–ù–û!"
echo "============================================="
echo "üåê –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä: http://46.173.19.68:3001"
echo "üìö –ö–∞—Ç–∞–ª–æ–≥ –º–æ–Ω–µ—Ç: http://46.173.19.68:3000"
echo "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: pm2 status"
echo "üìã –õ–æ–≥–∏ –∫–∞—Ç–∞–ª–æ–≥–∞: pm2 logs catalog-interface"
